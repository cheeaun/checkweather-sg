function e(){import.meta.url,import("_").catch((()=>1)),async function*(){}().next()}import{i as t,g as n,p as a,$ as o,c as i,q as r,l as s,o as c,a as l,E as d,u as h,r as p,d as m,b as u,y as g,e as v,f as y,h as f,j as w}from"./vendor-PO0Zxmx7.js";import{m as x}from"./maplibre-gl-CDfLgF3w.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const b="/assets/arrow-down-white-DmoBF-j4.png";function M(e,t,n){return[[e[0]*(1-n)+t[0]*n,e[1]*(1-n)+t[1]*n],[e[0]*n+t[0]*(1-n),e[1]*n+t[1]*(1-n)]]}function _(e,t=1,n=!0,a=.25){if(t>10&&(t=10),0==t)return e;if(n){const o=e.length,i=[];for(let t=0;t<o;t++){const n=e[t],r=e[(t+1)%o],[s,c]=M(n,r,a);i.push(s,c)}return _(i,t-1,n,a)}a>.5&&(a=1-a);for(let o=0;o<t;o++){let t=[];t.push(e[0]);for(let n=1;n<e.length;n++){let o=M(e[n-1],e[n],a);t=t.concat(o)}n?t=t.concat(M(e[e.length-1],e[0],a)):t.push(e[e.length-1]),e=t}return e}const{VITE_MAPTILER_KEY:E}={LEGACY:!1,VITE_MAPTILER_KEY:"fRcAT46aniv3RwvKVv5C"},P=n(t({projectId:"check-weather-sg"})),F=217,B=1.156,L=1.475,z=103.565,C=104.13,I=Math.abs(.5649999999999977),A=Math.abs(L-B),D=a([[[-180,90],[180,90],[180,-90],[-180,-90],[-180,90]],[[z,L],[C,L],[C,B],[z,B],[z,L]]]),k=["#40FFFD","#3BEEEC","#32D0D2","#2CB9BD","#229698","#1C827D","#1B8742","#229F44","#27B240","#2CC53B","#30D43E","#38EF46","#3BFB49","#59FA61","#FEFB63","#FDFA53","#FDEB50","#FDD74A","#FCC344","#FAB03F","#FAA23D","#FB8938","#FB7133","#F94C2D","#F9282A","#DD1423","#BE0F1D","#B21867","#D028A6","#F93DF5"],T=k.length,R={type:"Polygon",coordinates:[[[103.56983184814452,1.1984523335134731],[103.71986389160156,1.1459349466540576],[104.13459777832031,1.2763684180848154],[104.0789794921875,1.3580576343735706],[104.09442901611328,1.3913503559342686],[104.08344268798828,1.4260154737416286],[104.04155731201172,1.4462651532861726],[103.97151947021484,1.4229265238497912],[103.9368438720703,1.4304772829308758],[103.89667510986328,1.4263586901405338],[103.86817932128906,1.4555318956783565],[103.81153106689452,1.4788701887242242],[103.75968933105469,1.4469515799492016],[103.72535705566406,1.4596504356431457],[103.67523193359375,1.4308204986633148],[103.65943908691406,1.4067952740787528],[103.61721038818358,1.323391529857783],[103.56983184814452,1.1984523335134731]]]};window.$map&&window.$map.remove();const S=[z,B,C,L],j=()=>({padding:window.innerWidth>640&&window.innerHeight>640?120:0}),N=window.$map=new x.Map({container:"map",center:[103.8475,1.3011],style:"https://api.maptiler.com/maps/aecd4cb7-a35b-4c10-89aa-0f4bd52ed1cb/style.json?key=".concat(E),minZoom:8,maxZoom:14,renderWorldCopies:!1,boxZoom:!1,pitchWithRotate:!1,dragRotate:!1,touchPitch:!1,attributionControl:!1,bounds:S,fitBoundsOptions:j()});N.touchZoomRotate.disableRotation(),N.addControl(new x.NavigationControl({showCompass:!1}),"top-right"),N.addControl(new x.GeolocateControl({trackUserLocation:!0}),"top-right");N.addControl(new class{onAdd(e){this._map=e,this._container=document.createElement("div"),this._container.className="maplibregl-ctrl maplibregl-ctrl-group";const t=document.createElement("button");return t.type="button",t.title="Snap to boundary",t.innerHTML='<svg height="100%" width="100%" viewBox="0 0 24 24" fill="#333"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm-7 7H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4z"/></svg>',t.onclick=t=>{t.preventDefault(),this._container.hidden=!0,e.fitBounds(S,j(),{snap:!0})},this._container.appendChild(t),this._container.hidden=!0,e.on("moveend",(e=>{e.snap||(this._container.hidden=!1)})),this._container}onRemove(){this._container.parentNode.removeChild(this._container),this._map=void 0}},"top-right");const H=document.getElementById("loader");N.on("dataloading",(e=>{H.hidden=!1}));let V=null;N.on("data",(e=>{clearTimeout(V),V=setTimeout((()=>{H.hidden=!0}),500)}));const q=document.getElementById("legend"),O=document.getElementById("info-button"),U=document.getElementById("legend-close");O.onclick=e=>{e.preventDefault(),q.hidden=!q.hidden},U.onclick=e=>{e.preventDefault(),q.hidden=!0};const W=o((e=>(e.match(/\d{4}$/)||[""])[0].replace(/(\d{2})(\d{2})/,((e,t,n)=>{let a=parseInt(t,10);const o=a>=12?"PM":"AM";return 0==a&&(a=12),a>12&&(a-=12),a+":"+n+" "+o})))),Z=o((e=>p(z+e/F*I,4))),$=o((e=>p(L-e/120*A,4))),K=new Array(26040).fill(0),Y=o(((e,t)=>{const n=t.trimEnd().split(/\n/g),a=K.slice();for(let o=0,i=n.length;o<i;o++){const e=n[o];for(let t=e.search(/[^\s]/),n=e.length;t<n;t++){const n=e[t];if(n&&" "!==n){const e=n.charCodeAt()-33;a[o*F+t]=e}}}return a}),{maxArgs:1}),G=i().size([F,120]).thresholds([4,10,20,30,40,50,60,70,80,85,90,95,97.5]).smooth(!1),X=o(((e,t)=>{const n=[],a=G(t);for(let o=0,i=a.length;o<i;o++){const{type:t,value:i,coordinates:r}=a[o];r.length&&n.push({type:"Feature",properties:{intensity:i,id:e},geometry:{type:t,coordinates:r.map((e=>e.map((e=>(e.pop(),_(e).map((([e,t])=>[Z(e),$(t)])))))))}})}return n}),{maxArgs:1}),J=o(((e,t,n)=>{const a=[];for(let o=0,i=t.length;o<i;o++)a[o]=(t[o]+n[o])/2;return a}),{maxArgs:1}),Q=async()=>{try{const e=await fetch("https://api2.checkweather.sg/v1/observations");if(!e.ok)throw new Error("New API failed");const t=await e.json();console.log(t),ee(t)}catch(e){console.log("Falling back to old API"),fetch("https://api.checkweather.sg/v2/observations").then((e=>e.json())).then(ee).catch(console.error)}},ee=e=>{const t=e.map((e=>{const{id:t,lng:n,lat:a,...o}=e;return y([n,a],o,{id:t})})),n=f(t);N.getSource("observations").setData(n)},te=(e,t,n=!1)=>{n&&e(),setTimeout(requestAnimationFrame,t,(()=>{e(),te(e,t)}))},ne=({values:e=[],maxValue:t=null,smoothIterations:n=1,style:a={},...o})=>{if(!e.length)return null;const i=e.length-1,r=t||Math.max(...e);let s="";return _(e.map(((e,t)=>[Math.round(t/i*100),Math.round(e/r*100)])),n,!1).forEach(((e,t)=>{t>0&&(s+=","),s+="".concat(e[0],"% ").concat(100-e[1],"%")})),h("div",{...o,style:{...a,clipPath:"polygon(0 100%, ".concat(s,", 100% 100%)")}})};const ae=new Promise((e=>{N.once("styledata",e)})),oe=r(l(P,"weather"),c("id","desc"),s(25)),ie=["interpolate",["linear"],["zoom"],10,1,12,.25];let re=!0,se=!1;d(h((()=>{const[e,t]=m(!1),[n,a]=u(null),[o,i]=u([]),[r,s]=m(!1),[c,l]=m(!1),[d,p]=m(document.hidden);g((()=>{document.addEventListener("visibilitychange",(()=>{p(document.hidden)}),!1)}),[]);const y=function(e,t=1){let n;return function(...a){clearTimeout(n),n=setTimeout((()=>e.call(this,...a)),t)}}((e=>{re&&console.timeEnd("Fetch Snapshots"),t(!1);const o=e.docs.map((e=>e.data().coverage_percentage.all)).reduce(((e,t)=>e+t))/e.docs.length;console.log({averageCoverage:o}),se=o>25;const r=()=>{console.time("Process Snapshots");const t=[],o=[],r=e.docs.reverse();r.forEach(((e,n)=>{const a=e.data(),i=Y(a.id,a.radar),s=X(a.id,i);o.push(...s);const c=r[n+1];if(c&&!se){const e=c.data(),t=Y(e.id,e.radar),n="".concat((Number(a.id)+Number(e.id))/2),r=J(n,i,t),s=X(n,r);o.push(...s)}t.push(a)}));const s=f(o);ae.then((()=>{N.getFilter("rainradar")||N.setFilter("rainradar",["==","id",e.docs[0].data().id],{validate:!1}),N.getSource("rainradar").setData(s),n||a(t.length),i(t)})),console.timeEnd("Process Snapshots")};if(re){const t=e.docs[0].data(),n=Y(t.id,t.radar),a=X(t.id,n);ae.then((()=>{N.getSource("rainradar").setData(f(a)),re=!1,N.once("idle",(()=>requestAnimationFrame(r)))}))}else r()}),300);g((()=>{let e=()=>{};return d?(s(!1),re=!1):(console.log("Start Snapshots"),console.time("Fetch Snapshots"),t(!0),e=w(oe,y)),()=>e()}),[d]);const x=o.length;if(x<=1)return null;g((()=>{if(n&&x){const e=Math.round(n),t=.5*Math.round(n/.5);let a=o[e-1].id;if(t!==e&&!se){const e=o[Math.floor(t)-1],n=o[Math.ceil(t)-1];if(e&&n){a="".concat((e.dt+n.dt)/2)}}l(!1),N.setFilter("rainradar",["==","id",a],{validate:!1});const i=n<x-1;N.setPaintProperty("tempreadings","text-opacity",i?.3:1),N.setPaintProperty("humidreadings","text-opacity",i?.3:1),N.setPaintProperty("rainreadings","text-opacity",i?.3:1),N.setPaintProperty("windirections","icon-opacity",i?.1:.3),N.setPaintProperty("heatstress","icon-opacity",i?.1:ie)}}),[n,o]),g((()=>{n<x&&!r&&l(!0)}),[o]);const{id:b}=o[Math.round(n)-1],M=o.map((e=>e.coverage_percentage.sg)),_=Math.max(...M);v((()=>{const e=n>=x;e&&_<5?s(!1):a(e?1:n+.5)}),r?n===x?2e3:100:null);const E=(n-1)/(x-1)*100,P=Math.max(_/100*24,16);return h("div",{id:"player-content",class:e?"loading":"",children:[h("div",{id:"player-button",class:r?"playing":"",onClick:()=>{c?a(x):(n!==x||r||a(1),s(!r))},children:h("div",{id:"player-icon",children:h("svg",{width:P,height:P,viewBox:"0 0 24 24",children:h("path",{d:c?"M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z":r?"M6 19h4V5H6v14zm8-14v14h4V5h-4z":"M8 5v14l11-7z"})})})}),h("div",{id:"player-range",children:[h("div",{id:"player-time",class:n===x?"now":"",style:{left:"".concat(E,"%"),transform:"translateX(-".concat(E,"%)")},children:W(b)}),h(ne,{values:M,maxValue:100,smoothIterations:2,style:{height:40},id:"player-sparkline"}),h("progress",{value:n,max:x}),h("div",{id:"player-labels",children:[h("span",{children:W(o[0].id)}),h("span",{children:W(o[Math.round(x/2)-1].id)}),h("span",{children:W(o[x-1].id)})]}),h("input",{type:"range",min:"1",max:x,step:"any",value:n,onInput:e=>{s(!1),a(e.target.value)},onMouseUp:()=>a(Math.round(n)),onTouchEnd:e=>{a(Math.round(n));const t=e.changedTouches[0];if(t){const{width:e,x:n}=t.target.getBoundingClientRect(),o=8,i=e-2*o,r=(t.clientX-o-n)/i*(x-1)+1;a(Math.max(1,Math.min(x,Math.round(r))))}},onTouchCancel:()=>a(Math.round(n))})]})]})}),{}),document.getElementById("player")),(async()=>{await ae,N.addSource("observations",{type:"geojson",data:{type:"FeatureCollection",features:[]},tolerance:5,buffer:0,maxzoom:14}),N.addSource("rainradar",{type:"geojson",data:{type:"FeatureCollection",features:[]},maxzoom:14});const e=N.getStyle().layers;let t;for(let u=0;u<e.length;u++){const{id:n,type:a,layout:o}=e[u];if("symbol"===a&&o["text-field"]&&(t||(t=e[u].id)),"symbol"===a){const e=N.getPaintProperty(n,"text-opacity");N.setPaintProperty(n,"text-opacity",["case",["within",R],e||1,0]);const t=N.getPaintProperty(n,"icon-opacity");"number"==typeof t&&N.setPaintProperty(n,"icon-opacity",["case",["within",R],t||1,0])}}const n=["interpolate-lab",["linear"],["number",["get","intensity"],0],0,"transparent",...k.reduce(((e,t,n)=>{const a=(n+1)/T*100;return e.push(a,t),e}),[])],a={"fill-extrusion-color":"#070707","fill-extrusion-opacity":.6,"fill-extrusion-base":100,"fill-extrusion-height":101,"fill-extrusion-vertical-gradient":!1};N.addLayer({id:"water-overlay",type:"fill-extrusion",source:"openmaptiles","source-layer":"water",paint:a},t),N.addLayer({id:"rainradar",type:"fill-extrusion",source:"rainradar",paint:{"fill-extrusion-vertical-gradient":!1,"fill-extrusion-height":["number",["get","intensity"],0],"fill-extrusion-color":n,"fill-extrusion-opacity":["interpolate",["linear"],["zoom"],8,1,12,.15]}},"water-overlay"),N.addLayer({id:"tempreadings",type:"symbol",source:"observations",minzoom:8.5,filter:["all",["has","temp_celcius"],[">","temp_celcius",0]],layout:{"text-field":"{temp_celcius}°","text-allow-overlap":!0,"text-ignore-placement":!0,"text-size":["interpolate",["linear"],["zoom"],8,10,14,28],"text-padding":1,"text-font":["Noto Sans Regular"]},paint:{"text-color":"yellow","text-halo-color":"#000","text-halo-width":1.5}});const o=await N.loadImage(b);N.addImage("arrow",o.data);const i=await N.loadImage("/assets/fire-outline-black-gmx_FgcO.png");N.addImage("fire",i.data),N.addLayer({id:"windirections",type:"symbol",source:"observations",filter:["has","wind_direction"],layout:{"icon-image":"arrow","icon-rotate":["get","wind_direction"],"icon-allow-overlap":!0,"icon-ignore-placement":!0,"icon-size":["interpolate",["linear"],["zoom"],8,.05,14,.6]},paint:{"icon-opacity":.3}},"tempreadings"),N.addLayer({id:"humidreadings",type:"symbol",source:"observations",minzoom:10,filter:["all",["has","relative_humidity"],[">","relative_humidity",0]],layout:{"text-field":"{relative_humidity}%","text-ignore-placement":!0,"text-size":["interpolate",["linear"],["zoom"],8,8,14,14*1.1],"text-offset":[0,-1.2],"text-padding":0,"text-font":["Noto Sans Regular"]},paint:{"text-color":"orange","text-halo-color":"#000","text-halo-width":1.5}}),N.addLayer({id:"rainreadings",type:"symbol",source:"observations",minzoom:12,filter:["all",["has","rain_mm"],[">","rain_mm",0]],layout:{"text-field":"{rain_mm}mm","text-size":["interpolate",["linear"],["zoom"],8,8,14,14*1.1],"text-ignore-placement":!0,"text-offset":[0,1.2],"text-padding":0,"text-font":["Noto Sans Regular"]},paint:{"text-color":"aqua","text-halo-color":"#000","text-halo-width":1.5}});const r=.175,s=3*r,c=1.5*r;N.addLayer({id:"heatstress",type:"symbol",source:"observations",minzoom:8,filter:["all",["has","wbgt"],[">=",["get","wbgt"],31]],layout:{"icon-image":"fire","icon-allow-overlap":!0,"icon-ignore-placement":!0,"icon-size":["interpolate",["linear"],["zoom"],10,["case",["<",["get","wbgt"],33],r,c],14,["case",["<",["get","wbgt"],33],s,.7874999999999999]]},paint:{"icon-opacity":ie}}),te(Q,12e4,!0);const l=document.getElementById("weather-popover"),d=document.getElementById("weather-popover-body"),h=document.getElementById("tap-circle"),p=()=>{l.classList.add("closing"),l.addEventListener("animationend",(()=>{l.classList.remove("closing"),l.hidePopover()}),{once:!0})};let m;document.getElementById("weather-popover-content").onclick=()=>{p()},N.on("click",(e=>{clearTimeout(m),m=setTimeout((()=>{const t=e.lngLat.lng,n=e.lngLat.lat,a=N.getZoom(),o=30*(40075016.686*Math.abs(Math.cos(n*Math.PI/180))/Math.pow(2,a+8))/111320,i=N.project([t,n]);h.style.left=i.x-30+"px",h.style.top=i.y-30+"px",h.style.width="60px",h.style.height="60px",h.style.display="block";const r=N.getSource("observations")._data;if(!r||!r.features||0===r.features.length)return;const s=[];if(r.features.forEach((e=>{const[a,i]=e.geometry.coordinates,r=Math.sqrt(Math.pow(a-t,2)+Math.pow(i-n,2));r<=o&&s.push({feature:e,distance:r})})),h.style.animation="none",h.offsetHeight,h.style.animation="",h.className="",0===s.length)return void(l.matches(":popover-open")&&p());s.sort(((e,t)=>e.distance-t.distance));const c=s.slice(0,3);let m="<h3>Readings nearby</h3>",u=!1;c.forEach((e=>{const t=e.feature.properties,n=e.feature.id||t.id||"Unknown",a=t.name;let o="";if(void 0!==t.temp_celcius&&(o+='<div class="weather-reading">\n          <div class="weather-reading-header">\n            <span class="emoji">🌡️</span>\n            <span>Temperature</span>\n          </div>\n          <div class="weather-reading-value">'.concat(t.temp_celcius,"°C</div>\n        </div>")),void 0!==t.relative_humidity&&(o+='<div class="weather-reading">\n          <div class="weather-reading-header">\n            <span class="emoji">💧</span>\n            <span>Humidity</span>\n          </div>\n          <div class="weather-reading-value">'.concat(t.relative_humidity,"%</div>\n        </div>")),void 0!==t.rain_mm&&(o+='<div class="weather-reading">\n          <div class="weather-reading-header">\n            <span class="emoji">🌧️</span>\n            <span>Rain</span>\n          </div>\n          <div class="weather-reading-value">'.concat(t.rain_mm,"mm</div>\n        </div>")),void 0!==t.wind_speed||void 0!==t.wind_direction){let e="";if(void 0!==t.wind_speed){const n=Math.round(1.852*t.wind_speed);e+="".concat(n," km/h")}void 0!==t.wind_direction&&(e&&(e+=" "),e+='<img src="'.concat(b,'" class="wind-arrow" style="transform: rotate(').concat(t.wind_direction,'deg)" alt="Wind direction">')),o+='<div class="weather-reading">\n          <div class="weather-reading-header">\n            <span class="emoji">💨</span>\n            <span>Wind</span>\n          </div>\n          <div class="weather-reading-value">'.concat(e,"</div>\n        </div>")}if(void 0!==t.wbgt&&t.wbgt>=31){let e="moderate",n="Moderate";t.wbgt>=33&&(e="high",n="High"),o+='<div class="weather-reading heat-risk '.concat(e,'">\n          <div class="weather-reading-header">\n            <span class="emoji">🔥</span>\n            <span>Heat stress</span>\n          </div>\n          <div class="weather-reading-value">').concat(t.wbgt,"°C (").concat(n,")</div>\n        </div>")}o&&(u=!0,m+='<div class="weather-station">\n            <div class="station-name">'.concat(a||n,'</div>\n            <div class="weather-readings">\n              ').concat(o,"\n            </div>\n          </div>"))})),u?(h.classList.add("long-duration"),d.innerHTML=m,l.showPopover()):l.matches(":popover-open")&&p()}),200)})),N.on("dblclick",(()=>{clearTimeout(m)})),N.addLayer({id:"bbox",type:"fill",source:{type:"geojson",tolerance:10,buffer:0,data:D,maxzoom:14},paint:{"fill-color":"rgba(0,0,0,.5)","fill-antialias":!1}},t)})(),ae.then((()=>{new URL(window.location.href).searchParams.has("screensaver")&&(document.body.classList.add("screensaver"),N.fitBounds([[z,B],[C,L]]))}));navigator.vendor&&-1!==navigator.vendor.indexOf("Apple")&&setTimeout((function(){const e=window.devicePixelRatio,t=document.createElement("canvas"),n=t.width=window.screen.width*e,a=t.height=window.screen.height*e,o=t.getContext("2d");o.fillStyle="#343332",o.fillRect(0,0,n,a);const i=new Image;i.onload=()=>{const e=i.width/i.height;i.width=n/2,i.height=n/2/e,o.drawImage(i,(n-i.width)/2,(a-i.height)/2,i.width,i.height),document.head.insertAdjacentHTML("beforeend",'<link rel="apple-touch-startup-image" href="'.concat(t.toDataURL(),'">'))},i.src="/assets/icon-standalone-B-rVhTPE.svg"}),5e3);export{e as __vite_legacy_guard};
//# sourceMappingURL=index-CpGrdRRJ.js.map
